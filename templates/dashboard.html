{% extends "base.html" %}
{% block title %}Dashboard - CampusGigs{% endblock %}

{% block content %}
<div class="container mt-4 mb-5 pb-5">
    <div class="row">
<!-- profile card in dashboard -->
<div class="card shadow">
    <div class="card-body">
        <h2 class="text-center mb-3">My Profile</h2>
        <div class="text-center mb-4">
            <div class="position-relative d-inline-block">
                <img src="{{ user.profile_image|default('/img/Profile/default.jpg') }}" 
                     class="rounded-circle" 
                     alt="Profile Picture" 
                     style="width: 150px; height: 150px; object-fit: cover;">
                <button class="btn btn-sm btn-success position-absolute bottom-0 end-0"
                        data-bs-toggle="modal" 
                        data-bs-target="#updateProfileImageModal">
                    <i class="bi bi-camera"></i>
                </button>
            </div>
        </div>
        <div class="mb-3">
            <h5>{{ user.name }}</h5>
            <p class="text-muted">Student ID: {{ user.student_id }}</p>
            <p class="text-muted">{{ user.email }}</p>
            <p>Degree: {{ user.degree_type }} {% if user.degree %}in {{ user.degree }}{% endif %}</p>
        </div>
        <div class="d-grid gap-2">
            <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                Edit Profile
            </button>
            <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#paymentInfoModal">
                Update Payment Info
            </button>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-success">Logout</a>
        </div>
    </div>
</div>

<!-- Add this new modal for profile image upload -->
<div class="modal fade" id="updateProfileImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Profile Picture</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="profileImageForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="profileImage" class="form-label">Choose Image</label>
                        <input type="file" class="form-control" id="profileImage" name="profile_image" 
                               accept="image/jpeg,image/png,image/jpg">
                        <div class="form-text">Max file size: 5MB. Supported formats: JPG, PNG</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="uploadProfileImage()">Upload</button>
            </div>
        </div>
    </div>
</div>
            
            <!-- Balance Card -->
            <div class="card shadow mt-4">
                <div class="card-body">
                    <h4 class="card-title">My Balance</h4>
                    <h2 class="text-success">${{ user.balance|default(0.00)|round(3) }}</h2>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addFundsModal">Add Funds</button>
                        <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#withdrawFundsModal">Withdraw</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Dashboard Content -->
        <div class="col-md-8">
            <!-- Active Jobs -->
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">My Active Jobs</h4>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="jobTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="posted-tab" data-bs-toggle="tab" data-bs-target="#posted" type="button" role="tab">Jobs I Posted</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="accepted-tab" data-bs-toggle="tab" data-bs-target="#accepted" type="button" role="tab">Jobs I Accepted</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-3" id="jobTabsContent">
                        <!-- Jobs I Posted Tab -->
                        <div class="tab-pane fade show active" id="posted" role="tabpanel">
                            <div class="list-group">
                                <!-- This would be populated from backend -->
                                <a href="#" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">Pick up my textbook</h5>
                                        <span class="badge bg-success">$15.00</span>
                                    </div>
                                    <p class="mb-1">Library pickup - Education Building</p>
                                    <small class="text-muted">Posted yesterday · In Progress</small>
                                </a>
                                <a href="#" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">Coffee delivery</h5>
                                        <span class="badge bg-success">$5.00</span>
                                    </div>
                                    <p class="mb-1">Starbucks to Science Building</p>
                                    <small class="text-muted">Posted 3 days ago · Waiting for acceptor</small>
                                </a>
                            </div>
                            <div class="d-grid mt-3">
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#postJobModal">Post New Job</button>
                            </div>
                        </div>
                        
                        <!-- Jobs I Accepted Tab -->
                        <div class="tab-pane fade" id="accepted" role="tabpanel">
                            <div class="list-group">
                                <!-- This would be populated from backend -->
                                <a href="#" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">Notes for BIO 101</h5>
                                        <span class="badge bg-success">$20.00</span>
                                    </div>
                                    <p class="mb-1">Share class notes for last week</p>
                                    <small class="text-muted">Accepted 2 hours ago · Due tomorrow</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Completed Jobs -->
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Completed Jobs</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive completed-jobs" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Job</th>
                                    <th>Date</th>
                                    <th>Role</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                            <!-- This will be populated dynamically -->

                            <tr>
                                <td>Dog walking</td>
                                <td>Jan 25, 2025</td>
                                <td>Provider</td>
                                <td class="text-success">+$10.00</td>
                            </tr>
                            <tr>
                                <td>Assignment help</td>
                                <td>Jan 20, 2025</td>
                                <td>Requester</td>
                                <td class="text-danger">-$18.00</td>
                            </tr>
                            <tr>
                                <td>Package delivery</td>
                                <td>Jan 15, 2025</td>
                                <td>Provider</td>
                                <td class="text-success">+$12.00</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="editName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editName" value="{{ user.name }}">
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" value="{{ user.email }}">
                    </div>
                    <div class="mb-3">
                        <label for="editDegreeType" class="form-label">Degree Type</label>
                        <select class="form-select" id="editDegreeType">
                            <option value="Undeclared" {% if user.degree_type == 'Undeclared' %}selected{% endif %}>Undeclared</option>
                            <option value="Associate" {% if user.degree_type == 'Associate' %}selected{% endif %}>Associate</option>
                            <option value="Bachelor" {% if user.degree_type == 'Bachelor' %}selected{% endif %}>Bachelor</option>
                            <option value="Master" {% if user.degree_type == 'Master' %}selected{% endif %}>Master</option>
                            <option value="Doctorate" {% if user.degree_type == 'Doctorate' %}selected{% endif %}>Doctorate</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editDegree" class="form-label">Degree/Major</label>
                        <input type="text" class="form-control" id="editDegree" value="{{ user.degree|default('') }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Info Modal -->
<div class="modal fade" id="paymentInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Payment Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="cardName" class="form-label">Name on Card</label>
                        <input type="text" class="form-control" id="cardName">
                    </div>
                    <div class="mb-3">
                        <label for="cardNumber" class="form-label">Card Number</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expiryDate" class="form-label">Expiry Date</label>
                            <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cvv" class="form-label">CVV</label>
                            <input type="text" class="form-control" id="cvv" placeholder="123">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success">Save Payment Info</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Funds Modal -->
<div class="modal fade" id="addFundsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Funds to Your Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="addAmount" class="form-label">Amount to Add ($)</label>
                        <input type="number" class="form-control" id="addAmount" min="5" step="1">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="savedCard" checked>
                            <label class="form-check-label" for="savedCard">
                                Use saved card (****1234)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="newCard">
                            <label class="form-check-label" for="newCard">
                                Use a different card
                            </label>
                        </div>
                    </div>
                    
                    <div id="newCardFields" class="d-none">
                        <!-- New card fields would go here, similar to payment info modal -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success">Add Funds</button>
            </div>
        </div>
    </div>
</div>

<!-- Withdraw Funds Modal -->
<div class="modal fade" id="withdrawFundsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Withdraw Funds</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="withdrawAmount" class="form-label">Amount to Withdraw ($)</label>
                        <input type="number" class="form-control" id="withdrawAmount" min="5" max="{{ user.balance|default(0) }}" step="1">
                        <small class="text-muted">Available balance: ${{ user.balance|default(0.00)|round(2) }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="withdrawMethod" class="form-label">Withdrawal Method</label>
                        <select class="form-select" id="withdrawMethod">
                            <option value="bank">Bank Transfer</option>
                            <option value="card">Credit Card Refund</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success">Withdraw Funds</button>
            </div>
        </div>
    </div>
</div>

<!-- Post Job Modal -->
<div class="modal fade" id="postJobModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Post a New Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="jobPostForm">
                    <!-- Job Type Selection -->
                    <div class="mb-3">
                        <label for="jobType" class="form-label">Job Type</label>
                        <select class="form-select" id="jobType" name="job_type" required onchange="updateJobFields()">
                            <option value="">Select a job type...</option>
                            <option value="creative_work">Creative Work</option>
                            <option value="academic_help">Academic Help</option>
                            <option value="food_delivery">Food Delivery</option>
                        </select>
                    </div>

                    <!-- Creative Work Fields -->
                    <div id="creative_work_fields" class="d-none">
                        <div class="mb-3">
                            <label for="jobTitle" class="form-label">Job Title</label>
                            <input type="text" class="form-control" name="job_title" required placeholder="e.g., Logo Design, Poster Creation">
                        </div>
                        <div class="mb-3">
                            <label for="jobDescription" class="form-label">Job Description</label>
                            <textarea class="form-control" name="job_description" rows="4" required placeholder="Describe the creative work you need..."></textarea>
                        </div>
                    </div>

                    <!-- Academic Help Fields -->
                    <div id="academic_help_fields" class="d-none">
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" name="subject" required placeholder="e.g., Calculus, Physics">
                        </div>
                        <div class="mb-3">
                            <label for="problemDescription" class="form-label">Problem Description</label>
                            <textarea class="form-control" name="problem_description" rows="4" required placeholder="Describe what you need help with..."></textarea>
                        </div>
                    </div>

                    <!-- Food Delivery Fields -->
                    <div id="food_delivery_fields" class="d-none">
                        <div class="mb-3">
                            <label for="restaurantName" class="form-label">Restaurant Name</label>
                            <input type="text" class="form-control" name="restaurant_name" required placeholder="e.g., Subway, Starbucks">
                        </div>
                        <div class="mb-3">
                            <label for="orderDescription" class="form-label">Order Description</label>
                            <textarea class="form-control" name="order_description" rows="4" required placeholder="Describe your order details..."></textarea>
                        </div>
                    </div>

                    <!-- Common Fields -->
                    <div id="common_fields" class="d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fee" class="form-label">Fee ($)</label>
                                <input type="number" class="form-control" name="fee" min="1" step="0.5" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="datetime" class="form-label">Date/Time Needed</label>
                                <input type="datetime-local" class="form-control" name="datetime" required>
                            </div>
                        </div>

                        <!-- Meetup Fields (only for creative_work and academic_help) -->
                        <div id="meetup_fields">
                            <div class="mb-3">
                                <label for="meetupType" class="form-label">Meetup Type</label>
                                <select class="form-select" name="meetup_type" required onchange="toggleLocationField()">
                                    <option value="ONLINE">Online</option>
                                    <option value="IN_PERSON">In Person</option>
                                </select>
                            </div>
                            <div class="mb-3 d-none" id="locationField">
                                <label for="location" class="form-label">Meeting Location</label>
                                <input type="text" class="form-control" name="location" placeholder="e.g., Library, Student Union">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitJob()">Post Job</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>



<script>// Function to update job fields based on selection
    function updateJobFields() {
        const jobType = document.getElementById('jobType').value;
        
        // Hide all specific job type fields first
        const allFields = ['creative_work_fields', 'academic_help_fields', 'food_delivery_fields', 'common_fields'];
        allFields.forEach(fields => {
            document.getElementById(fields)?.classList.add('d-none');
        });
        
        // If no job type is selected, return early
        if (!jobType) {
            return;
        }
        
        // Show the selected job type fields and common fields
        document.getElementById(`${jobType}_fields`)?.classList.remove('d-none');
        document.getElementById('common_fields').classList.remove('d-none');
        
        // Show/hide meetup fields based on job type
        const meetupFields = document.getElementById('meetup_fields');
        if (jobType === 'food_delivery') {
            meetupFields.classList.add('d-none');
            // Add delivery-specific fields
            document.getElementById('locationField').classList.remove('d-none');
            document.querySelector('input[name="location"]').setAttribute('placeholder', 'Delivery Location (e.g., Dorm Room, Library)');
            document.querySelector('input[name="location"]').required = true;
        } else {
            meetupFields.classList.remove('d-none');
            // Reset location field
            document.getElementById('locationField').classList.add('d-none');
            document.querySelector('input[name="location"]').required = false;
        }
        
        // Update required fields based on job type
        updateRequiredFields(jobType);
    }
    
    // Function to update required fields based on job type
    function updateRequiredFields(jobType) {
        // Reset all required fields first
        const allInputs = document.querySelectorAll('#jobPostForm input, #jobPostForm textarea, #jobPostForm select');
        allInputs.forEach(input => {
            input.required = false;
        });
        
        // Set common required fields
        document.querySelector('input[name="fee"]').required = true;
        document.querySelector('input[name="datetime"]').required = true;
        
        // Set job-type specific required fields
        switch(jobType) {
            case 'creative_work':
                document.querySelector('input[name="job_title"]').required = true;
                document.querySelector('textarea[name="job_description"]').required = true;
                document.querySelector('select[name="meetup_type"]').required = true;
                break;
                
            case 'academic_help':
                document.querySelector('input[name="subject"]').required = true;
                document.querySelector('textarea[name="problem_description"]').required = true;
                document.querySelector('select[name="meetup_type"]').required = true;
                break;
                
            case 'food_delivery':
                document.querySelector('input[name="restaurant_name"]').required = true;
                document.querySelector('textarea[name="order_description"]').required = true;
                document.querySelector('input[name="location"]').required = true;
                break;
        }
    }
    
    // Function to toggle location field visibility
    function toggleLocationField() {
        const meetupType = document.querySelector('select[name="meetup_type"]').value;
        const locationField = document.getElementById('locationField');
        const locationInput = document.querySelector('input[name="location"]');
        
        if (meetupType === 'IN_PERSON') {
            locationField.classList.remove('d-none');
            locationInput.required = true;
        } else {
            locationField.classList.add('d-none');
            locationInput.required = false;
        }
    }
    
    // Function to validate and submit the job form
    async function submitJob() {
        const form = document.getElementById('jobPostForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const formData = new FormData(form);
        const jobType = formData.get('job_type');
        
        let requestBody = {
            job_type: jobType,
            fee: parseFloat(formData.get('fee')),
            datetime: formData.get('datetime')
        };
        
        // Add job-type specific fields
        switch(jobType) {
            case 'creative_work':
                requestBody = {
                    ...requestBody,
                    title: formData.get('job_title'),
                    description: formData.get('job_description'),
                    meetup_type: formData.get('meetup_type'),
                    location: formData.get('meetup_type') === 'IN_PERSON' ? formData.get('location') : null
                };
                break;
                
            case 'academic_help':
                requestBody = {
                    ...requestBody,
                    subject: formData.get('subject'),
                    description: formData.get('problem_description'),
                    meetup_type: formData.get('meetup_type'),
                    location: formData.get('meetup_type') === 'IN_PERSON' ? formData.get('location') : null
                };
                break;
                
            case 'food_delivery':
                requestBody = {
                    ...requestBody,
                    restaurant_name: formData.get('restaurant_name'),
                    description: formData.get('order_description'),
                    delivery_location: formData.get('location')
                };
                break;
        }
        
        try {
            const response = await fetch('/api/jobs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: JSON.stringify(requestBody)
            });
            
            if (response.ok) {
                showAlert('success', 'Job posted successfully!');
                $('#postJobModal').modal('hide');
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error('Failed to post job');
            }
        } catch (error) {
            showAlert('danger', 'Failed to post job. Please try again.');
            console.error('Error:', error);
        }
    }
    
    // Initialize the form when the modal is shown
    document.getElementById('postJobModal').addEventListener('show.bs.modal', function () {
        const form = document.getElementById('jobPostForm');
        form.reset();
        updateJobFields();
    });
    
    // Add event listeners once DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        const jobTypeSelect = document.getElementById('jobType');
        const meetupTypeSelect = document.querySelector('select[name="meetup_type"]');
        
        jobTypeSelect?.addEventListener('change', updateJobFields);
        meetupTypeSelect?.addEventListener('change', toggleLocationField);
    });
    </script>
    
{% endblock %}



