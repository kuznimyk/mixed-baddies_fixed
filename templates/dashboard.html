{% extends "base.html" %}
{% block title %}Dashboard - CampusGigs{% endblock %}

{% block content %}
<div class="container mt-4 mb-5 pb-5">
    <div class="row">
        <!-- Left Column - Profile and Balance -->
        <div class="col-md-4">
            <!-- Profile card -->
            <div class="card shadow">
                <div class="card-body">
                    <h2 class="text-center mb-3">My Profile</h2>
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            <img src="{{ user.profile_image|default('/img/Profile/default.jpg') }}" 
                                 class="rounded-circle" 
                                 alt="Profile Picture" 
                                 style="width: 150px; height: 150px; object-fit: cover;">
                            <button class="btn btn-sm btn-success position-absolute bottom-0 end-0"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#updateProfileImageModal">
                                <i class="bi bi-camera"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h5>{{ user.name }}</h5>
                        <p class="text-muted">Student ID: {{ user.student_id }}</p>
                        <p class="text-muted">{{ user.email }}</p>
                        <p>Degree: {{ user.degree_type }} {% if user.degree %}in {{ user.degree }}{% endif %}</p>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            Edit Profile
                        </button>
                        <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#paymentInfoModal">
                            Update Payment Info
                        </button>
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-success">Logout</a>
                    </div>
                </div>
            </div>
            
            <!-- Edit profile modal -->
            <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class = "modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <!--Accessibility features-->
                    <div class="mb-3">
                        <label for="AccessibilityType" class="form-label fw-bold">Accessibility Settings</label>
                        <div class="input-group shadow-sm border rounded bg-white">
                            <select class="form-select border-0 bg-white" id="AccessibilityType" name="Accessibility_type">
                                <option value="light_mode">Light Mode (Default)</option>
                                <option value="dark_mode">Dark Mode</option>
                                <option value="colorBlind_mode">Color Blind Mode</option>
                            </select>
                        </div>
                    </div>

            </form>
            </div>
            </div>
            </div>


            
           
            
            <!-- Balance Card -->
            <div class="card shadow mt-4">
                <div class="card-body">
                    <h4 class="card-title">My Balance</h4>
                    <h2 class="text-success">${{ user.balance|default(0.00)|round(3) }}</h2>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addFundsModal">Add Funds</button>
                        <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#withdrawFundsModal">Withdraw</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Jobs -->
        <div class="col-md-8">
            <!-- Active Jobs -->
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">My Active Jobs</h4>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="jobTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="posted-tab" data-bs-toggle="tab" data-bs-target="#posted" type="button" role="tab">Jobs I Posted</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="accepted-tab" data-bs-toggle="tab" data-bs-target="#accepted" type="button" role="tab">Jobs I Accepted</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-3" id="jobTabsContent">
                        <!-- Jobs I Posted Tab -->
                        <div class="tab-pane fade show active" id="posted" role="tabpanel">
                            <div class="list-group">
                                <a href="#" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">Pick up my textbook</h5>
                                        <span class="badge bg-success">$15.00</span>
                                    </div>
                                    <p class="mb-1">Library pickup - Education Building</p>
                                    <small class="text-muted">Posted yesterday · In Progress</small>
                                </a>
                                <a href="#" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">Coffee delivery</h5>
                                        <span class="badge bg-success">$5.00</span>
                                    </div>
                                    <p class="mb-1">Starbucks to Science Building</p>
                                    <small class="text-muted">Posted 3 days ago · Waiting for acceptor</small>
                                </a>
                            </div>
                            <div class="d-grid mt-3">
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#postJobModal">Post New Job</button>
                            </div>
                        </div>
                        
                        <!-- Jobs I Accepted Tab -->
                        <div class="tab-pane fade" id="accepted" role="tabpanel">
                            <div class="list-group">
                                <a href="#" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">Notes for BIO 101</h5>
                                        <span class="badge bg-success">$20.00</span>
                                    </div>
                                    <p class="mb-1">Share class notes for last week</p>
                                    <small class="text-muted">Accepted 2 hours ago · Due tomorrow</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Completed Jobs -->
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Completed Jobs</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive completed-jobs" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Job</th>
                                    <th>Date</th>
                                    <th>Role</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Dog walking</td>
                                    <td>Jan 25, 2025</td>
                                    <td>Provider</td>
                                    <td class="text-success">+$10.00</td>
                                </tr>
                                <tr>
                                    <td>Assignment help</td>
                                    <td>Jan 20, 2025</td>
                                    <td>Requester</td>
                                    <td class="text-danger">-$18.00</td>
                                </tr>
                                <tr>
                                    <td>Package delivery</td>
                                    <td>Jan 15, 2025</td>
                                    <td>Provider</td>
                                    <td class="text-success">+$12.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Post Job Modal -->
<div class="modal fade" id="postJobModal" tabindex="-1" aria-labelledby="postJobModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="postJobModalLabel">Post a New Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="jobPostForm">
                    <!-- Job Type Selection -->
                    <div class="mb-3">
                        <label for="jobType" class="form-label">Job Type</label>
                        <select class="form-select" id="jobType" name="job_type" required>
                            <option value="">Select a job type</option>
                            <option value="creative_work">Creative Work</option>
                            <option value="academic_help">Academic Help</option>
                            <option value="food_delivery">Food Delivery</option>
                        </select>
                    </div>

                    <!-- Creative Work Fields -->
                    <div id="creative_work_fields" class="d-none">
                        <div class="mb-3">
                            <label for="job_title" class="form-label">Job Title</label>
                            <input type="text" class="form-control" id="job_title" name="job_title" required>
                        </div>
                        <div class="mb-3">
                            <label for="job_description" class="form-label">Job Description</label>
                            <textarea class="form-control" id="job_description" name="job_description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="creative_fee" class="form-label">Fee ($)</label>
                            <input type="number" class="form-control" id="creative_fee" name="fee" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="creative_meetup_type" class="form-label">Meetup Type</label>
                            <select class="form-select" id="creative_meetup_type" name="meetup_type" onchange="toggleLocationField('creative')" required>
                                <option value="VIRTUAL">Virtual</option>
                                <option value="IN_PERSON">In Person</option>
                            </select>
                        </div>
                        <div class="mb-3 location-field" id="creative_location_field" style="display: none;">
                            <label for="creative_location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="creative_location" name="location">
                        </div>
                        <div class="mb-3">
                            <label for="creative_datetime" class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-control" id="creative_datetime" name="datetime" required>
                        </div>
                    </div>

                    <!-- Academic Help Fields -->
                    <div id="academic_help_fields" class="d-none">
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="subject" name="subject" required>
                        </div>
                        <div class="mb-3">
                            <label for="academic_fee" class="form-label">Fee ($)</label>
                            <input type="number" class="form-control" id="academic_fee" name="fee" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="problem_description" class="form-label">Problem Description</label>
                            <textarea class="form-control" id="problem_description" name="problem_description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="academic_meetup_type" class="form-label">Meetup Type</label>
                            <select class="form-select" id="academic_meetup_type" name="meetup_type" onchange="toggleLocationField('academic')" required>
                                <option value="VIRTUAL">Virtual</option>
                                <option value="IN_PERSON">In Person</option>
                            </select>
                        </div>
                        <div class="mb-3 location-field" id="academic_location_field" style="display: none;">
                            <label for="academic_location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="academic_location" name="location">
                        </div>
                        <div class="mb-3">
                            <label for="academic_datetime" class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-control" id="academic_datetime" name="datetime" required>
                        </div>
                    </div>

                    <!-- Food Delivery Fields -->
                    <div id="food_delivery_fields" class="d-none">
                        <div class="mb-3">
                            <label for="restaurant_name" class="form-label">Restaurant Name</label>
                            <input type="text" class="form-control" id="restaurant_name" name="restaurant_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="order_description" class="form-label">Order Description</label>
                            <textarea class="form-control" id="order_description" name="order_description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="delivery_fee" class="form-label">Fee ($)</label>
                            <input type="number" class="form-control" id="delivery_fee" name="fee" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="delivery_datetime" class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-control" id="delivery_datetime" name="datetime" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitJob()">Post Job</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

<script>

    // Dark mode: 
    document.addEventListener("DOMContentLoaded", function () {
    const accessibilitySelect = document.getElementById("AccessibilityType");

    // Load saved preference
    const savedMode = localStorage.getItem("accessibilityMode");
    if (savedMode) {
        applyAccessibilityMode(savedMode);
        accessibilitySelect.value = savedMode;
    }

    // Event listener for mode change
    accessibilitySelect.addEventListener("change", function () {
        const selectedMode = this.value;
        applyAccessibilityMode(selectedMode);
        localStorage.setItem("accessibilityMode", selectedMode); // Save preference
    });

    function applyAccessibilityMode(mode) {
        document.body.classList.remove("dark-mode", "colorblind-mode", "light-mode");
        
        if (mode === "dark_mode") {
            document.body.classList.add("dark-mode");
        } else if (mode === "colorBlind_mode") {
            document.body.classList.add("colorblind-mode");
        } else {
            document.body.classList.add("light-mode");
        }
    }
    });
    // Function to update job fields based on selection
    function updateJobFields() {
        const jobType = document.getElementById('jobType').value;
        
        // Hide all fields first
        ['creative_work_fields', 'academic_help_fields', 'food_delivery_fields'].forEach(fields => {
            document.getElementById(fields).classList.add('d-none');
        });
        
        // Show selected job type fields
        if (jobType) {
            document.getElementById(`${jobType}_fields`).classList.remove('d-none');
        }
    }
    
    // Function to toggle location field visibility
    function toggleLocationField(prefix) {
        const meetupType = document.getElementById(`${prefix}_meetup_type`).value;
        const locationField = document.getElementById(`${prefix}_location_field`);
        locationField.style.display = meetupType === 'IN_PERSON' ? 'block' : 'none';
        
        // Clear location value if virtual
        if (meetupType === 'VIRTUAL') {
            document.getElementById(`${prefix}_location`).value = '';
        }
    }
    
    // Function to submit the job form
    async function submitJob() {
        const form = document.getElementById('jobPostForm');
        const formData = new FormData(form);
        const jobType = formData.get('job_type');
        
        if (!jobType) {
            showAlert('danger', 'Please select a job type');
            return;
        }
        
        let requestBody = {};
        
        // Get common fields based on job type
        const prefix = jobType.replace('-', '_');
        requestBody = {
            job_type: jobType,
            fee: parseFloat(document.getElementById(`${prefix}_fee`).value),
            datetime: document.getElementById(`${prefix}_datetime`).value
        };
        
        // Add specific fields based on job type
        switch(jobType) {
            case 'creative_work':
                requestBody = {
                    ...requestBody,
                    job_title: document.getElementById('job_title').value,
                    job_description: document.getElementById('job_description').value,
                    meetup_type: document.getElementById('creative_meetup_type').value,
                    location: document.getElementById('creative_meetup_type').value === 'IN_PERSON' 
                        ? document.getElementById('creative_location').value 
                        : null
                };
                break;
                
            case 'academic_help':
                requestBody = {
                    ...requestBody,
                    subject: document.getElementById('subject').value,
                    problem_description: document.getElementById('problem_description').value,
                    meetup_type: document.getElementById('academic_meetup_type').value,
                    location: document.getElementById('academic_meetup_type').value === 'IN_PERSON' 
                        ? document.getElementById('academic_location').value 
                        : null
                };
                break;
                
            case 'food_delivery':
                requestBody = {
                    ...requestBody,
                    restaurant_name: document.getElementById('restaurant_name').value,
                    order_description: document.getElementById('order_description').value
                };
                break;
        }
        
        try {
            const response = await fetch('/api/jobs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: JSON.stringify(requestBody)
            });
            
            if (response.ok) {
                const result = await response.json();
                showAlert('success', 'Job posted successfully!');
                $('#postJobModal').modal('hide');
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error('Failed to post job');
            }
        } catch (error) {
            showAlert('danger', 'Failed to post job. Please try again.');
            console.error('Error:', error);
        }
    }
    
    // Function to display alerts
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
        
        // Auto-dismiss alert after 3 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }
    
    // Profile image upload functionality
    async function uploadProfileImage() {
        const form = document.getElementById('profileImageForm');
        const formData = new FormData(form);
        
        try {
            const response = await fetch('/api/users/me/profile-image', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: formData
            });
            
            if (response.ok) {
                showAlert('success', 'Profile picture updated successfully!');
                $('#updateProfileImageModal').modal('hide');
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error('Failed to update profile picture');
            }
        } catch (error) {
            showAlert('danger', 'Failed to update profile picture. Please try again.');
        }
    }
    
    // Initialize page functionality when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize job type dropdown handler
        const jobTypeDropdown = document.getElementById('jobType');
        if (jobTypeDropdown) {
            jobTypeDropdown.addEventListener('change', updateJobFields);
        }
        
        // Initialize Bootstrap tooltips
        var tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltips.map(function(tooltip) {
            return new bootstrap.Tooltip(tooltip);
        });
        
        // Initialize Bootstrap modals
        var modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('hidden.bs.modal', function () {
                // Reset forms when modal is closed
                const forms = this.querySelectorAll('form');
                forms.forEach(form => form.reset());
                
                // Hide all job type fields
                ['creative_work_fields', 'academic_help_fields', 'food_delivery_fields'].forEach(fields => {
                    const element = document.getElementById(fields);
                    if (element) element.classList.add('d-none');
                });
            });
        });
    });
    </script>
{% endblock %}